name: Playwright Tests
on:
  push:
    branches: [ main, master ]
    paths:
      - 'apps/web/**'
      - 'apps/api/**'
      - 'crates/**'
      - 'packages/**'
      - 'tests/**'
      - 'playwright.config.ts'
      - 'playwright.docker.config.ts'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'pnpm-workspace.yaml'
      - 'compose.e2e.yml'
      - 'docker/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/playwright.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'apps/web/**'
      - 'apps/api/**'
      - 'crates/**'
      - 'packages/**'
      - 'tests/**'
      - 'playwright.config.ts'
      - 'playwright.docker.config.ts'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'pnpm-workspace.yaml'
      - 'compose.e2e.yml'
      - 'docker/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/playwright.yml'
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - name: Build images
      run: docker compose -f compose.e2e.yml build
      env:
        DOCKER_BUILDKIT: 1
    - name: Initialize infrastructure
      run: docker compose -f compose.e2e.yml up -d db rustfs && docker compose -f compose.e2e.yml --profile init run --rm createbuckets
    - name: Run E2E tests
      run: docker compose -f compose.e2e.yml up --no-build --abort-on-container-exit --exit-code-from playwright
    - name: Cleanup
      if: always()
      run: docker compose -f compose.e2e.yml --profile init down -v
    - uses: actions/upload-artifact@v6
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
    - uses: actions/upload-artifact@v6
      if: ${{ !cancelled() }}
      with:
        name: test-results
        path: test-results/
        retention-days: 30
